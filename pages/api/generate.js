// pages/api/generate.js
import { GoogleGenAI } from "@google/genai";

const apiKey = process.env.GEMINI_API_KEY;

export default async function handler(req, res) {
  // ะัะพะฒะตััะตะผ ะผะตัะพะด ะทะฐะฟัะพัะฐ
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'ะะตัะพะด ะฝะต ัะฐะทัะตััะฝ. ะัะฟะพะปัะทัะนัะต POST.' });
  }

  const { promptText } = req.body;

  // ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต ัะตะบััะฐ ะทะฐะฟัะพัะฐ
  if (!promptText) {
    return res.status(400).json({ error: 'ะััััััะฒัะตั promptText ะฒ ัะตะปะต ะทะฐะฟัะพัะฐ.' });
  }

  // ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต API ะบะปััะฐ
  if (!apiKey) {
    console.error("ะะจะะะะ: GEMINI_API_KEY ะพััััััะฒัะตั ะธะปะธ ะฝะตะฒะตัะฝะพ ะฝะฐัััะพะตะฝ ะฒ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั Vercel.");
    return res.status(500).json({ 
      error: 'API-ะบะปัั ะฝะต ะฝะฐัััะพะตะฝ. ะัะพะฒะตัััะต ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั Vercel.',
      user_message: 'ะะทะฒะธะฝะธัะต, ัะธััะตะผะฐ ะธัะบััััะฒะตะฝะฝะพะณะพ ะธะฝัะตะปะปะตะบัะฐ ะฒัะตะผะตะฝะฝะพ ะฝะตะดะพัััะฟะฝะฐ. ะะพะถะฐะปัะนััะฐ, ะฟะพะฟัะพะฑัะนัะต ะฟะพะทะถะต.'
    });
  }

  const ai = new GoogleGenAI(apiKey);

  // >>>>>> ะกะะกะขะะะะซะ ะะะกะขะะฃะะฆะะ (SYSTEM_INSTRUCTION) <<<<<<
  const SYSTEM_INSTRUCTION = `
    ะั โ ัะบัะฟะตัั ะฟะพ ะผะฐัะบะตัะธะฝะณั ัััะธััะธัะตัะบะธั ะฝะฐะฟัะฐะฒะปะตะฝะธะน. ะะฐัะฐ ะทะฐะดะฐัะฐ โ ะฟัะตะฒัะฐัะธัั ะปัะฑัะต ะดะฐะฝะฝัะต ะธะปะธ ะพะฟะธัะฐะฝะธะต, ะฟัะตะดะพััะฐะฒะปะตะฝะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปะตะผ, ะฒ ะฝะตะฒะตัะพััะฝะพ ะฟัะธะฒะปะตะบะฐัะตะปัะฝัะน ัะตะบะปะฐะผะฝัะน "Caption" (ัะตะบัั) ะดะปั ััััะบะพัะทััะฝะพะน ะฐัะดะธัะพัะธะธ. 
    ะกะปะตะดัะนัะต ััะธะผ ะฟัะฐะฒะธะปะฐะผ:

    1. **ะฏะทัะบ:** ะธัะฟะพะปัะทัะนัะต ัะพะปัะบะพ **ััััะบะธะน ัะทัะบ**.
    2. **ะกัะธะปั:** ัะผะพัะธะพะฝะฐะปัะฝัะน, ะฒะดะพัะฝะพะฒะปัััะธะน, ะฒัะทัะฒะฐััะธะน ะถะตะปะฐะฝะธะต ะฟััะตัะตััะฒะพะฒะฐัั.
    3. **ะะฐัะฐะปะพ:** ะฝะฐัะธะฝะฐะนัะต ั **ะฒะพะฟัะพัะฐ, ะฟัะพะฑัะถะดะฐััะตะณะพ ะธะฝัะตัะตั**, ะธะปะธ **ัะผะตะปะพะณะพ ัะตะบะปะฐะผะฝะพะณะพ ะทะฐัะฒะปะตะฝะธั**, ะบะพัะพัะพะต ะผะณะฝะพะฒะตะฝะฝะพ ะฒัะทัะฒะฐะตั ะถะตะปะฐะฝะธะต ะฟะพะตัะฐัั.
    4. **ะญะผะพะดะทะธ (Emojis):** ะธัะฟะพะปัะทัะนัะต ะฟะพะดัะพะดััะธะต ััะบะธะต ัะผะพะดะทะธ (๐๏ธ โจ โ๏ธ ๐ ๐น ะธ ะดั.), ััะพะฑั ัะดะตะปะฐัั ัะตะบัั ะถะธะฒัะผ ะธ ะฟัะธะฒะปะตะบะฐัะตะปัะฝัะผ.
    5. **ะกัััะบัััะฐ:** ัะฐะทะดะตะปะธัะต ะพัะฒะตั ะฝะฐ ะบะพัะพัะบะธะต, ัะพะฑะปะฐะทะฝะธัะตะปัะฝัะต ะฟะพะดะทะฐะณะพะปะพะฒะบะธ ะธ ะฐะฑะทะฐัั. ะะฐะถะดัะน ะดะพะปะถะตะฝ ัะฐัะบััะฒะฐัั ะบะปััะตะฒัะต ะฟัะตะธะผััะตััะฒะฐ.
    6. **ะะฐะบะปััะตะฝะธะต:** ะทะฐะฒะตััะธัะต ัะฑะตะดะธัะตะปัะฝัะผ ะฟัะธะทัะฒะพะผ ะบ ะดะตะนััะฒะธั โ ะฝะฐะฟัะธะผะตั, โะะฐะฑัะพะฝะธััะนัะต ัะตะนัะฐั!โ ะธะปะธ โะกะฒัะถะธัะตัั ั ะฝะฐะผะธ ัะตะณะพะดะฝั!โ.
  `;
  // >>>>>> ะะะะะฆ ะกะะกะขะะะะซะฅ ะะะกะขะะฃะะฆะะ <<<<<<

  try {
    const prompt = `ะัะตะพะฑัะฐะทัะน ััะพ ัััะธััะธัะตัะบะพะต ะพะฟะธัะฐะฝะธะต ะฒ ะทะฐัะฒะฐััะฒะฐััะธะน ัะตะบะปะฐะผะฝัะน Caption ะฝะฐ ััััะบะพะผ ัะทัะบะต: "${promptText}"`;

    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: prompt,
      config: {
        systemInstruction: SYSTEM_INSTRUCTION,
      },
    });

    // ะัะพะฒะตััะตะผ ัะตะทัะปััะฐั
    const generatedText = response.text?.trim();
    if (!generatedText) {
      throw new Error("ะัััะพะน ะพัะฒะตั ะพั ะผะพะดะตะปะธ.");
    }

    res.status(200).json({ caption: generatedText });

  } catch (error) {
    console.error('ะัะธะฑะบะฐ Gemini API:', error.message);
    res.status(500).json({
      error: `ะัะธะฑะบะฐ ะฟัะธ ะพะฑัะฐัะตะฝะธะธ ะบ AI: ${error.message}`,
      user_message: 'ะัะพะธะทะพัะปะฐ ะพัะธะฑะบะฐ ะฟัะธ ัะพะทะดะฐะฝะธะธ ัะตะบะปะฐะผะฝะพะณะพ ัะตะบััะฐ. ะะพะถะฐะปัะนััะฐ, ะฟะพะฟัะพะฑัะนัะต ัะฝะพะฒะฐ.'
    });
  }
}
