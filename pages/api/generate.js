// pages/api/generate.js
import { GoogleGenAI } from "@google/genai";

const apiKey = process.env.GEMINI_API_KEY;

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method Not Allowed' });
  }

  const { promptText } = req.body;

  if (!promptText) {
    return res.status(400).json({ error: 'Missing promptText in request body' });
  }

  if (!apiKey) {
    console.error("ERROR: GEMINI_API_KEY is missing or invalid in Vercel Environment Variables.");
    return res.status(500).json({ 
        error: 'API Key Not Configured. Please check Vercel Environment Variables.',
        user_message: 'Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ð˜Ð˜ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð° Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.'
    });
  }
  
  const ai = new GoogleGenAI(apiKey);
  
  // >>>>>> Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ù…Ø¹Ø¯Ù„Ø© <<<<<<
  const SYSTEM_INSTRUCTION = `
    Ð’Ñ‹ â€” ÑÐºÑÐ¿ÐµÑ€Ñ‚ Ð¿Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸ÑŽ Ð½ÐµÐ¾Ñ‚Ñ€Ð°Ð·Ð¸Ð¼Ñ‹Ñ…, Ð¿Ñ€Ð¾Ð´Ð°ÑŽÑ‰Ð¸Ñ… Ñ‚ÐµÐºÑÑ‚Ð¾Ð² Ð´Ð»Ñ Ñ‚ÑƒÑ€Ð¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð°Ð³ÐµÐ½Ñ‚ÑÑ‚Ð².
    Ð’Ð°ÑˆÐ° Ð·Ð°Ð´Ð°Ñ‡Ð°: ÐŸÑ€ÐµÐ²Ñ€Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ð¿Ñ€Ð¸Ð²Ð»ÐµÐºÐ°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ñ€ÐµÐºÐ»Ð°Ð¼Ð½Ñ‹Ð¹ Ð¿Ð¾ÑÑ‚ Ð´Ð»Ñ Ñ€ÑƒÑÑÐºÐ¾ÑÐ·Ñ‹Ñ‡Ð½Ð¾Ð¹ Ð°ÑƒÐ´Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸.

    Ð¡Ð¢Ð ÐžÐ“Ðž ÐŸÐ ÐÐ’Ð˜Ð›Ð Ð’Ð«Ð’ÐžÐ”Ð:
    1.  **Ð¯Ð·Ñ‹Ðº:** Ð¢Ð¾Ð»ÑŒÐºÐ¾ **Ð ÑƒÑÑÐºÐ¸Ð¹**.
    2.  **ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ:** ÐžÐ±Ñ‰Ð°Ñ Ð´Ð»Ð¸Ð½Ð° Ñ‚ÐµÐºÑÑ‚Ð° Ð½Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð° Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°Ñ‚ÑŒ **1024 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°** (Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ Ð¿Ñ€Ð¾Ð±ÐµÐ»Ñ‹ Ð¸ ÑÐ¼Ð¾Ð´Ð·Ð¸). Ð¢ÐµÐºÑÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ñ‘Ð¼ÐºÐ¸Ð¼ Ð¸ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¼.
    3.  **Ð¡Ñ‚Ð¸Ð»ÑŒ:** Ð­Ð¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹, ÑƒÐ±ÐµÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹, Ñ€Ð¾ÑÐºÐ¾ÑˆÐ½Ñ‹Ð¹ (Premium).
    4.  **Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ:**
        * **Ð˜ÑÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ** Ð³Ð¾Ñ€Ð¸Ð·Ð¾Ð½Ñ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÐµÐ»Ð¸ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ---) Ð¸Ð»Ð¸ Ð¶Ð¸Ñ€Ð½Ñ‹Ðµ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ***Ð—ÐÐ“ÐžÐ›ÐžÐ’ÐžÐš***).
        * Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÑÐ¼Ð¾Ð´Ð·Ð¸ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, â˜€ï¸, ðŸ’Ž, âœˆï¸, ðŸ½ï¸) Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ Ð¿ÑƒÐ½ÐºÑ‚Ð¾Ð² ÑÐ¿Ð¸ÑÐºÐ° Ð´Ð»Ñ Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸, **Ñ‚Ð¾Ñ‡Ð½Ð¾ ÐºÐ°Ðº Ð² Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ðµ**.
        * Ð Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð½Ð° ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ Ð°Ð±Ð·Ð°Ñ†Ñ‹/Ð±Ð»Ð¾ÐºÐ¸ Ð¿Ð¾ Ñ‚ÐµÐ¼Ð°Ð¼ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÐžÑ‚Ð´Ñ‹Ñ…, ÐŸÐ¸Ñ‚Ð°Ð½Ð¸Ðµ, Ð Ð°Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ, Ð‘Ð¾Ð½ÑƒÑ).
    5.  **ÐÐ°Ñ‡Ð°Ð»Ð¾:** ÐÐ°Ñ‡Ð½Ð¸Ñ‚Ðµ Ñ Ð¼Ð¾Ñ‰Ð½Ð¾Ð³Ð¾, Ñ†ÐµÐ¿Ð»ÑÑŽÑ‰ÐµÐ³Ð¾ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ° Ð¸Ð»Ð¸ Ñ„Ñ€Ð°Ð·Ñ‹.
    6.  **ÐšÐ¾Ð½ÐµÑ†:** Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚Ðµ Ñ‡ÐµÑ‚ÐºÐ¸Ð¼ Ð¿Ñ€Ð¸Ð·Ñ‹Ð²Ð¾Ð¼ Ðº Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸ÑŽ (Call to Action) Ð¸ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, "ÐŸÐ¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð¼ Ð² WhatsApp!").
  `;
  // >>>>>> Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© <<<<<<

  try {
    const prompt = `ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐ¹Ñ‚Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ñ‚ÐµÐºÑÑ‚/Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ð¿Ñ€Ð¸Ð²Ð»ÐµÐºÐ°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹, Ð¿Ñ€Ð¾Ð´Ð°ÑŽÑ‰Ð¸Ð¹ Ñ€ÐµÐºÐ»Ð°Ð¼Ð½Ñ‹Ð¹ Ð¿Ð¾ÑÑ‚ Ð½Ð° Ð ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ (Ð´Ð¾ 1024 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²) Ñ ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð¸ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¼Ð¸ Ð°Ð±Ð·Ð°Ñ†Ð°Ð¼Ð¸, Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÐµÐ»Ð¸ "--**": "${promptText}"`;
    
    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash", 
      contents: prompt,
      config: {
        systemInstruction: SYSTEM_INSTRUCTION,
      },
    });

    const generatedText = response.text.trim();
    res.status(200).json({ caption: generatedText });

  } catch (error) {
    console.error('Gemini API Error:', error.message);
    res.status(500).json({ 
        error: `AI call failed: ${error.message}`,
        user_message: 'ÐŸÑ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð¿Ñ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·.'
    });
  }
}
